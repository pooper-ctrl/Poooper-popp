<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>Poop Leah Poop ‚Äî RPG Mode</title>
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<style>
  /* Pixel-perfect vibe */
  html, body { height: 100%; margin: 0; background: #0b0d14; color: #e6e6f0; }
  body { font-family: system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, "Noto Sans"; }
  #wrap { display:grid; grid-template-columns: 1fr 320px; gap: 10px; padding: 10px; height: 100%; box-sizing: border-box; }
  #left { display:grid; grid-template-rows: auto 1fr; gap:8px; }
  #titlebar { display:flex; align-items:center; justify-content:space-between; background:#14182a; border:1px solid #202235; border-radius:8px; padding:8px 12px; }
  #titlebar h1 { margin:0; font-size:18px; }
  #titlebar .small { font-size:12px; color:#9aa0a6; display:flex; gap:8px; }
  #gamewrap { background:#14182a; border:1px solid #202235; border-radius:8px; padding:8px; }
  canvas { width: 100%; height: auto; image-rendering: pixelated; image-rendering: crisp-edges; background:#0e1220; border-radius:6px; display:block; }
  #right { display:grid; grid-template-rows: auto 1fr auto; gap:8px; }
  .panel { background:#14182a; border:1px solid #202235; border-radius:8px; padding:10px; }
  #hud { display:grid; grid-template-columns:repeat(3,1fr); gap:6px; }
  .stat { background:#0d1020; border:1px solid #202235; border-radius:6px; padding:6px; font-size:12px; }
  .bar { margin-top:4px; height:8px; background:#0a0d18; border:1px solid #1b1f30; border-radius:4px; overflow:hidden; }
  .fill { height:100%; width:0%; background:linear-gradient(90deg,#5eead4,#60a5fa); }
  .fill.red { background:linear-gradient(90deg,#f87171,#fbbf24); }
  .fill.pink { background:linear-gradient(90deg,#f38ba8,#cba6f7); }
  #log { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace; font-size:12px; color:#cbd5e1; height:100%; overflow:auto; white-space:pre-wrap; }
  #keys { font-size:12px; color:#9aa0a6; }
  .kbd { font-family: ui-monospace, monospace; background:#121424; border:1px solid #242a45; padding:0 6px; border-radius:4px; }
  #footer { display:flex; align-items:center; justify-content:space-between; font-size:12px; color:#9aa0a6; }
  /* RPG windows */
  .win { position:absolute; background:#0e1326; border:2px solid #39436b; box-shadow:0 0 0 2px #1b2140 inset; padding:8px; }
  .win h3 { margin:0 0 6px 0; font-size:12px; color:#a5b4fc; }
  #dialog { left:8px; right:8px; bottom:8px; min-height:56px; display:none; }
  #menu { right:8px; top:8px; width:160px; display:none; }
  #menu .item { padding:4px 6px; border-radius:4px; margin:2px 0; }
  #menu .item.sel { background:#1b2242; }
  #overlay { position:absolute; inset:0; pointer-events:none; }
</style>
</head>
<body>
<div id="wrap">
  <div id="left">
    <div id="titlebar">
      <h1>üí© Poop Leah Poop ‚Äî RPG Mode</h1>
      <div class="small">
        <span>Day <span id="dayNum">1</span></span>
        <span><span id="timeStr">06:00</span></span>
        <span>Streak <span id="streak">0</span></span>
      </div>
    </div>
    <div id="gamewrap">
      <canvas id="game" width="256" height="192" aria-label="Poop Leah Poop RPG canvas"></canvas>
      <div id="overlay">
        <div id="dialog" class="win"><div id="dialogText"></div></div>
        <div id="menu" class="win">
          <h3>Items</h3>
          <div id="menuList"></div>
        </div>
      </div>
    </div>
  </div>
  <div id="right">
    <div class="panel">
      <div id="hud">
        <div class="stat"><strong>Energy</strong> <span id="eVal">0</span><div class="bar"><div class="fill" id="eBar"></div></div></div>
        <div class="stat"><strong>Urge</strong> <span id="uVal">0</span><div class="bar"><div class="fill pink" id="uBar"></div></div></div>
        <div class="stat"><strong>Stress</strong> <span id="sVal">0</span><div class="bar"><div class="fill red" id="sBar"></div></div></div>
      </div>
    </div>
    <div class="panel">
      <strong>Event Log</strong>
      <div id="log"></div>
    </div>
    <div id="footer" class="panel">
      <div id="keys">
        Move <span class="kbd">Arrows/WASD</span> ‚Ä¢ Interact/OK <span class="kbd">Z / Space</span> ‚Ä¢ Menu <span class="kbd">X / Enter</span>
      </div>
      <div>RPG v1.0</div>
    </div>
  </div>
</div>

<script>
/* =========================================================
   Core: utilities
========================================================= */
const clamp=(v,min,max)=>Math.max(min,Math.min(max,v));
const rnd=(a,b)=>Math.random()*(b-a)+a;
const SAVE_KEY="poop-leah-rpg-v10";
function fmtTime(mins){ let m=Math.floor(mins)%(24*60); let h=Math.floor(m/60), mm=m%60; return String(h).padStart(2,'0')+":"+String(mm).padStart(2,'0'); }

/* =========================================================
   Sound: tiny chiptune bleeps
========================================================= */
const Sound=(()=>{
  const ctx=new (window.AudioContext||window.webkitAudioContext)();
  const master=ctx.createGain(); master.gain.value=0.5; master.connect(ctx.destination);
  function beep(f=440,d=0.08,t="square",v=0.2){
    const o=ctx.createOscillator(); const g=ctx.createGain();
    o.type=t; o.frequency.value=f; g.gain.value=v; o.connect(g); g.connect(master);
    const now=ctx.currentTime; g.gain.setValueAtTime(v,now); g.gain.exponentialRampToValueAtTime(0.0001,now+d); o.start(now); o.stop(now+d+0.01);
  }
  return { step(){beep(320,0.07)}, confirm(){beep(660,0.08)}, cancel(){beep(220,0.08,"triangle")}, talk(){beep(520,0.04)}, bad(){beep(140,0.15,"sawtooth")}, yay(){beep(520,0.12); setTimeout(()=>beep(660,0.12),90);}, };
})();

/* =========================================================
   Game state
========================================================= */
const defaultState=()=>({
  day:1, time:6*60, streak:0, poopedToday:false, missedYesterday:false,
  stats:{ energy:70, urge:10, stress:20, fiber:20, hydration:35, motility:20 },
  mapId:"room", x:7, y:7, facing:"down",
});
let state=load()||defaultState();

function save(){ localStorage.setItem(SAVE_KEY, JSON.stringify(state)); }
function load(){ try{ return JSON.parse(localStorage.getItem(SAVE_KEY)); }catch(e){ return null; } }
function logMsg(t){ const el=document.getElementById("log"); el.textContent+=`[${fmtTime(state.time)}] ${t}\n`; el.scrollTop=el.scrollHeight; }

/* =========================================================
   RPG data: tiles, maps, items
========================================================= */
const TS=16; // tile size
// tileset palette (drawn procedurally)
const TILE = {
  FLOOR:0, WALL:1, DOOR:2, TOILET:3, GRASS:4, PATH:5, SIGN:6, BED:7, WATER:8
};
// simple 16x12 maps (fits 256x192 exactly)
const maps = {
  room: {
    name:"Room",
    tiles:[
      [1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],
      [1,0,0,0,0,0,0,0,0,0,0,0,0,6,0,1],
      [1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],
      [1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],
      [1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],
      [1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],
      [1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],
      [1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],
      [1,0,0,0,0,0,0,0,0,0,0,0,0,0,7,1],
      [1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],
      [1,0,0,0,0,0,0,0,0,0,0,0,0,0,2,1],
      [1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],
    ],
    exits:{ "14,10":{to:"bath", tx:1, ty:10, facing:"right"} },
    interact:{
      "13,1": {type:"sign", text:"Microbe Choir practices outside."},
      "14,8": {type:"bed"},
    }
  },
  bath: {
    name:"Bathroom",
    tiles:[
      [1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],
      [1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],
      [1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],
      [1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],
      [1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],
      [1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],
      [1,0,0,0,0,0,3,0,0,0,0,0,0,0,0,1],
      [1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],
      [1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],
      [1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],
      [1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,1],
      [1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],
    ],
    exits:{ "2,10":{to:"room", tx:14, ty:10, facing:"left"} },
    interact:{
      "6,6": {type:"toilet"},
    }
  },
  outside: {
    name:"Outside",
    tiles:[
      [4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4],
      [4,4,4,5,5,5,5,5,5,5,5,5,5,4,4,4],
      [4,4,4,5,4,4,4,4,4,4,4,4,5,4,4,4],
      [4,4,4,5,4,4,4,4,4,4,4,4,5,4,4,4],
      [4,4,4,5,4,4,4,6,4,4,4,4,5,4,4,4],
      [4,4,4,5,4,4,4,4,4,4,4,4,5,4,4,4],
      [4,4,4,5,5,5,5,5,5,5,5,5,5,4,4,4],
      [4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4],
      [4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4],
      [4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4],
      [4,4,4,4,4,4,4,4,4,4,4,4,4,4,2,4],
      [4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4],
    ],
    exits:{ "14,10":{to:"room", tx:14, ty:9, facing:"up"} },
    interact:{ "7,4": {type:"sign", text:"ü¶† Microbe Choir: Pet for buffs (Z)."} }
  }
};

// items and their effects (JRPG-style menu)
const items=[
  {id:"beans", name:"Beans ü´ò", use:()=> applyDelta({fiber:+18, stress:-3, energy:-5}, 10, "Bean power enters the chat.")},
  {id:"water", name:"Water üíß", use:()=> applyDelta({hydration:+18, energy:-2}, 5, "Hydration: organs applaud.")},
  {id:"walk", name:"Walk üö∂", use:()=> applyDelta({motility:+16, stress:-10, energy:-12}, 25, "You stroll with purpose."), notInBath:true},
  {id:"relax", name:"Relax üìñ", use:()=> applyDelta({stress:-14, energy:+8}, 20, "Relaxation unlocks a secret shoulder.")},
  {id:"yogurt", name:"Yogurt ü•£", use:()=> applyDelta({motility:+10, stress:-4}, 8, "The bacteria bazaar convenes.")},
  {id:"coffee", name:"Coffee ‚òï", use:()=> applyCoffee()},
  {id:"chili", name:"Chili üå∂Ô∏è", use:()=> applyChili()},
  {id:"try", name:"Try üí©", use:()=> tryPoop(), onlyInBath:true},
  {id:"sleep", name:"Sleep üõèÔ∏è", use:()=> sleepIfBed(), onlyInRoom:true},
];
let coffeeTimer=0;

/* =========================================================
   Canvas + drawing helpers
========================================================= */
const cvs=document.getElementById("game"), ctx=cvs.getContext("2d");
function drawTile(id, x, y){
  // very low-fi "tileset" drawn with shapes
  switch(id){
    case 0: ctx.fillStyle="#1b2140"; ctx.fillRect(x,y,16,16); ctx.fillStyle="#242a54"; ctx.fillRect(x+1,y+1,14,14); break;
    case 1: ctx.fillStyle="#0f1428"; ctx.fillRect(x,y,16,16); ctx.fillStyle="#2a335a"; ctx.fillRect(x,y,16,4); break;
    case 2: ctx.fillStyle="#3b2f2f"; ctx.fillRect(x+4,y,8,16); ctx.fillStyle="#d1a54a"; ctx.fillRect(x+10,y+8,2,2); break;
    case 3: ctx.fillStyle="#cbd5e1"; ctx.fillRect(x+4,y+6,8,6); ctx.fillStyle="#94a3b8"; ctx.fillRect(x+5,y+4,6,2); break;
    case 4: ctx.fillStyle="#0d1a12"; ctx.fillRect(x,y,16,16); ctx.fillStyle="#123922"; ctx.fillRect(x+1,y+1,14,14); break;
    case 5: ctx.fillStyle="#3a2c1a"; ctx.fillRect(x,y,16,16); ctx.fillStyle="#6b4f2e"; ctx.fillRect(x+2,y+2,12,12); break;
    case 6: ctx.fillStyle="#7c4a34"; ctx.fillRect(x+5,y+8,6,6); ctx.fillStyle="#5b3a29"; ctx.fillRect(x+3,y+4,10,6); break;
    case 7: ctx.fillStyle="#285"; ctx.fillRect(x+1,y+10,14,5); ctx.fillStyle="#48a"; ctx.fillRect(x+1,y+1,14,9); break;
    case 8: ctx.fillStyle="#0a2238"; ctx.fillRect(x,y,16,16); ctx.fillStyle="#164b7a"; ctx.fillRect(x+1,y+1,14,14); break;
  }
}

function drawLeah(px, py, facing){
  // 12x16 spritey blob
  ctx.fillStyle="rgba(0,0,0,0.25)"; ctx.fillRect(px-6, py+10, 12,3);
  const skin="#f1c27d", hair="#3b2f2f", shirt="#6ee7b7", pants="#334155", eye="#1f2937";
  ctx.fillStyle=skin; ctx.fillRect(px-4,py-12,8,8);
  ctx.fillStyle=hair; ctx.fillRect(px-5,py-12,10,3); ctx.fillRect(px-6,py-9,2,4);
  ctx.fillStyle=eye;
  if (facing==="left"){ ctx.fillRect(px-3,py-9,1,1); }
  else if (facing==="right"){ ctx.fillRect(px+2,py-9,1,1); }
  else { ctx.fillRect(px-2,py-9,1,1); ctx.fillRect(px+1,py-9,1,1); }
  ctx.fillStyle=shirt; ctx.fillRect(px-5,py-4,10,7);
  ctx.fillStyle=skin; ctx.fillRect(px-7,py-4,2,6); ctx.fillRect(px+5,py-4,2,6);
  ctx.fillStyle=pants; ctx.fillRect(px-4,py+3,3,7); ctx.fillRect(px+1,py+3,3,7);
}

/* =========================================================
   HUD + windows
========================================================= */
const dayNum=document.getElementById("dayNum");
const timeStr=document.getElementById("timeStr");
const streakEl=document.getElementById("streak");
const eVal=document.getElementById("eVal"), uVal=document.getElementById("uVal"), sVal=document.getElementById("sVal");
const eBar=document.getElementById("eBar"), uBar=document.getElementById("uBar"), sBar=document.getElementById("sBar");

const dialog=document.getElementById("dialog"), dialogText=document.getElementById("dialogText");
function say(text){ dialogText.textContent=text; dialog.style.display="block"; Sound.talk(); }
function closeDialog(){ dialog.style.display="none"; }

const menu=document.getElementById("menu"), menuList=document.getElementById("menuList");
let menuIdx=0;
function openMenu(){
  menuIdx=0; refreshMenu(); menu.style.display="block"; Sound.confirm();
}
function closeMenu(){ menu.style.display="none"; Sound.cancel(); }
function refreshMenu(){
  menuList.innerHTML="";
  const here=state.mapId;
  const filtered = items.filter(it=>!((it.onlyInBath && here!=="bath") || (it.onlyInRoom && here!=="room") || (it.notInBath && here==="bath")));
  filtered.forEach((it,i)=>{
    const div=document.createElement("div");
    div.className="item"+(i===menuIdx?" sel":"");
    div.textContent=it.name;
    menuList.appendChild(div);
  });
}

function updateHUD(){
  dayNum.textContent=state.day;
  timeStr.textContent=fmtTime(state.time);
  streakEl.textContent=state.streak;
  const S=state.stats;
  eVal.textContent=Math.round(S.energy); eBar.style.width=clamp(S.energy,0,100)+"%";
  uVal.textContent=Math.round(S.urge); uBar.style.width=clamp(S.urge,0,100)+"%";
  sVal.textContent=Math.round(S.stress); sBar.style.width=clamp(S.stress,0,100)+"%";
}

/* =========================================================
   Movement + collisions
========================================================= */
const dirs={up:[0,-1], down:[0,1], left:[-1,0], right:[1,0]};
const solid = new Set([1, 8]); // WALL, WATER
let tween=null; // movement tween

function canWalk(nx,ny){
  const m=maps[state.mapId]; if (!m) return false;
  if (nx<0||ny<0||nx>=16||ny>=12) return false;
  const t=m.tiles[ny][nx];
  return !solid.has(t);
}
function tryMove(dx,dy, facing){
  if (tween) return;
  const nx=state.x+dx, ny=state.y+dy;
  state.facing=facing;
  if (!canWalk(nx,ny)){ Sound.bad(); return; }
  const m=maps[state.mapId]; // exits?
  const ex = m.exits && m.exits[`${nx},${ny}`];
  if (ex){
    state.mapId=ex.to; state.x=ex.tx; state.y=ex.ty; state.facing=ex.facing||"down";
    logMsg(`You enter ${maps[state.mapId].name}.`); Sound.step(); advanceMinutes(2); return;
  }
  const start={x:state.x, y:state.y}; const end={x:nx, y:ny};
  const t0=performance.now();
  tween = (now)=>{
    const t=Math.min(1,(now-t0)/120);
    drawScene( start.x + (end.x-start.x)*t, start.y + (end.y-start.y)*t );
    if (t>=1){ tween=null; state.x=nx; state.y=ny; drawScene(); Sound.step(); advanceMinutes(2); }
    else requestAnimationFrame(()=>tween(performance.now()));
  };
  requestAnimationFrame(()=>tween(performance.now()));
}

function interactHere(){
  const m=maps[state.mapId];
  const d=dirs[state.facing]||[0,1];
  const tx=state.x+d[0], ty=state.y+d[1];
  const k=`${tx},${ty}`;

  if (m.interact && m.interact[k]){
    const it=m.interact[k];
    if (it.type==="sign"){ say(it.text); }
    if (it.type==="toilet"){ say("You assume the throne. Use Try üí© in the menu."); }
    if (it.type==="bed"){ say("Bed looks inviting. Use Sleep in the menu to end the day."); }
    return;
  }

  const t=m.tiles[ty]?.[tx];
  if (t===2){ say("A door. Walk into it to travel."); return; }

  say("You ponder existence. It wiggles back.");
}

/* =========================================================
   Stats & actions
========================================================= */
function applyDelta(deltas, mins, msg){
  const S=state.stats;
  for (const k of Object.keys(deltas)){ S[k]=clamp(S[k]+deltas[k], 0, 120); }
  advanceMinutes(mins);
  logMsg(msg);
  updateHUD();
}
function applyCoffee(){
  const S=state.stats;
  const spike=20+Math.floor(Math.random()*10);
  S.urge=clamp(S.urge+spike,0,120); S.energy=clamp(S.energy+6,0,100);
  coffeeTimer=60; advanceMinutes(5); logMsg(`Coffee casts Gastrocolic. Urge +${spike}. Jitters in ~60m.`);
}
function applyChili(){
  const S=state.stats; const r=Math.random();
  if (r<0.5){ S.motility=clamp(S.motility+16,0,120); logMsg("Chili gives you motility rockets."); }
  else if (r<0.8){ S.stress=clamp(S.stress+8,0,100); logMsg("Spice anxiety vibes."); }
  else { S.urge=clamp(S.urge+24,0,120); logMsg("Urgent rumble approaches."); }
  S.energy=clamp(S.energy-4,0,100); advanceMinutes(12);
}
function tryPoop(){
  if (state.mapId!=="bath"){ say("This is not the throne room."); Sound.bad(); return; }
  const S=state.stats;
  const urgeScore=S.urge*1.15;
  const calm=(100-S.stress)/100;
  const vigor=clamp(S.energy,20,100)/100;
  const base=urgeScore*calm*vigor;
  const threshold=60+Math.min(20,(state.day-1)*1.2);
  advanceMinutes(6);
  if (base>=threshold && S.urge>=35){
    const relief=Math.min(50,22+Math.round((base-threshold)/2));
    S.urge=clamp(S.urge-relief,0,100); S.stress=clamp(S.stress-14,0,100); S.energy=clamp(S.energy+10,0,100);
    state.poopedToday=true; logMsg("üí© SUCCESS! A majestic deposit is made."); Sound.yay(); closeDialog();
  } else {
    S.stress=clamp(S.stress+6,0,100); logMsg("Not yet. Build the urge, calm the mind."); Sound.bad();
  }
  updateHUD();
}
function sleepIfBed(){
  if (state.mapId!=="room"){ say("You yearn for your bed's gravitational field."); return; }
  if (!(state.x===14 && state.y===8)){ say("Stand next to the bed (right side)."); return; }
  endOfDay(true);
}

/* =========================================================
   Day cycle & time
========================================================= */
const minutesPerSecond=(24*60)/90; // ~90s per day
let lastTick=performance.now();
function advanceMinutes(mins){ state.time+=mins; tickMetabolism(mins); checkDayWrap(); save(); updateHUD(); }
function tickMetabolism(mins){
  const S=state.stats;
  S.fiber=clamp(S.fiber-mins*0.03,0,120);
  S.hydration=clamp(S.hydration-mins*0.04,0,120);
  S.motility=clamp(S.motility-mins*0.025,0,120);
  S.energy=clamp(S.energy-mins*0.03,0,100);
  const gutSync=(S.fiber*0.022 + S.hydration*0.018 + S.motility*0.024) * (1 - S.stress/180);
  const circ=state.time%(24*60);
  const morning=(circ>360 && circ<720) ? 1.25 : 1.0;
  S.urge=clamp(S.urge + mins*(0.06*morning) + mins*gutSync/1000, 0, 120);
  if (coffeeTimer>0){ coffeeTimer-=mins; if (coffeeTimer<=0){ S.stress=clamp(S.stress+12,0,100); S.energy=clamp(S.energy-8,0,100); logMsg("Coffee jitters arrive. Stress +12."); } }
}
function checkDayWrap(){ if (state.time>=24*60) endOfDay(false); }
function endOfDay(manual){
  if (state.poopedToday){ state.streak+=1; state.missedYesterday=false; logMsg(`Day ${state.day} complete ‚úÖ. Streak +1!`); }
  else {
    if (state.missedYesterday){ logMsg(`Missed again ‚ùå. Soft reset.`); state=defaultState(); save(); return; }
    state.missedYesterday=true; logMsg(`Missed today ‚ùå. Tomorrow demands excellence.`);
  }
  state.day+=1; state.time=6*60; state.poopedToday=false;
  const S=state.stats; S.energy=clamp(S.energy+30,0,100); S.stress=clamp(S.stress-10,0,100); S.urge=clamp(S.urge-8,0,100);
  logMsg(`Sunrise. Day ${state.day} begins.`);
}

/* =========================================================
   Render loop
========================================================= */
function drawScene(ix=state.x, iy=state.y){
  ctx.fillStyle="#0b0e18"; ctx.fillRect(0,0,cvs.width,cvs.height);
  const m=maps[state.mapId];
  for (let y=0;y<12;y++){
    for (let x=0;x<16;x++){
      drawTile(m.tiles[y][x], x*16, y*16);
    }
  }
  ctx.fillStyle="#9aa0a6"; ctx.font="8px monospace";
  if (state.mapId==="room"){ ctx.fillText("Bed",14*16+2,8*16-2); ctx.fillText("Door",14*16+1,10*16-2); ctx.fillText("Sign",13*16+2,1*16-2); }
  if (state.mapId==="bath"){ ctx.fillText("Toilet",6*16+1,6*16-2); ctx.fillText("Door",2*16+1,10*16-2); }
  if (state.mapId==="outside"){ ctx.fillText("To Room",14*16,10*16-2); ctx.fillText("Choir",7*16,4*16-2); }

  const px = Math.round(ix*16 + 8);
  const py = Math.round(iy*16 + 8);
  drawLeah(px, py, state.facing);
}

function loop(now){
  const dt=(now-lastTick)/1000; lastTick=now;
  state.time += dt*minutesPerSecond;
  tickMetabolism(dt*minutesPerSecond);
  updateHUD();
  if (!tween) drawScene();
  checkDayWrap();
  requestAnimationFrame(loop);
}
requestAnimationFrame(loop);

/* =========================================================
   Input
========================================================= */
window.addEventListener("keydown",(e)=>{
  if (e.repeat) return;
  const k=e.code;
  if (menu.style.display==="block"){
    if (k==="ArrowDown"){ menuIdx=(menuIdx+1)%items.length; refreshMenu(); Sound.step(); }
    else if (k==="ArrowUp"){ menuIdx=(menuIdx-1+items.length)%items.length; refreshMenu(); Sound.step(); }
    else if (k==="Enter" || k==="KeyZ" || k==="Space"){
      const here=state.mapId;
      const list=items.filter(it=>!((it.onlyInBath && here!=="bath") || (it.onlyInRoom && here!=="room") || (it.notInBath && here==="bath")));
      const it=list[menuIdx%list.length]; if (it){ it.use(); }
      Sound.confirm();
    }
    else if (k==="Escape" || k==="KeyX"){ closeMenu(); }
    return;
  }
  if (dialog.style.display==="block"){ if (k==="Enter" || k==="Space" || k==="KeyX" || k==="KeyZ"){ closeDialog(); Sound.cancel(); } return; }

  if (k==="ArrowUp"||k==="KeyW") tryMove(0,-1,"up");
  else if (k==="ArrowDown"||k==="KeyS") tryMove(0,1,"down");
  else if (k==="ArrowLeft"||k==="KeyA") tryMove(-1,0,"left");
  else if (k==="ArrowRight"||k==="KeyD") tryMove(1,0,"right");
  else if (k==="KeyZ" || k==="Space"){ interactHere(); }
  else if (k==="Enter" || k==="KeyX"){ openMenu(); }
});

/* =========================================================
   Boot
========================================================= */
if (!load()){ logMsg("Welcome to RPG Mode. Walk, interact with Z, open Menu with X/Enter, and find the toilet."); }
updateHUD(); drawScene();
</script>
</body>
</html>
